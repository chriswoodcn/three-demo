<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="Build/CesiumUnminified/Cesium.js"></script>
    <link rel="stylesheet" href="Build/Cesium/Widgets/widgets.css" />
    <script src="initMap.js"></script>
    <script>
      //在initMap.js进行初始化
      var viewer = null;
      //调整参数
      var params = {
        tx: 113.06265738392063, //模型中心X轴坐标（经度，单位：十进制度）
        ty: 22.647853971034342, //模型中心Y轴坐标（纬度，单位：十进制度）
        tz: -92, //模型中心Z轴坐标（高程，单位：米）
        rx: 0, //X轴（经度）方向旋转角度（单位：度）
        ry: 0, //Y轴（纬度）方向旋转角度（单位：度）
        rz: 2, //Z轴（高程）方向旋转角度（单位：度）
        scale: 1.3, //缩放比例
      };

      function load() {
        console.log("地图初始化");
        initMap(); //地图初始化
        //优化项--关闭相关特效
        viewer.scene.debugShowFramesPerSecond = true; //显示fps
        viewer.scene.moon.show = false; //月亮
        viewer.scene.fog.enabled = false; //雾
        viewer.scene.sun.show = false; //太阳
        viewer.scene.skyBox.show = false; //天空盒
        viewer.resolutionScale = 1.0; //画面细度，默认值为1.0
        //加载倾斜摄影
        loadPhoto();
      }
      //加载倾斜摄影
      function loadPhoto() {
        var tileset = viewer.scene.primitives.add(
          new Cesium.Cesium3DTileset({
            url: "http://10.254.10.38/baoli3dtile/tileset.json",
            maximumMemoryUsage: 100, //不可设置太高，目标机子空闲内存值以内，防止浏览器过于卡
            maximumScreenSpaceError: 20, //用于驱动细节细化级别的最大屏幕空间错误;较高的值可提供更好的性能，但视觉质量较低。
            maximumNumberOfLoadedTiles: 1000, //最大加载瓦片个数
            shadows: false, //是否显示阴影
            skipLevelOfDetail: true,
            baseScreenSpaceError: 1024,
            skipScreenSpaceErrorFactor: 16,
            skipLevels: 1,
            immediatelyLoadDesiredLevelOfDetail: false,
            loadSiblings: false,
            cullWithChildrenBounds: true,
            dynamicScreenSpaceError: true,
            dynamicScreenSpaceErrorDensity: 0.00278,
            dynamicScreenSpaceErrorFactor: 4.0,
            dynamicScreenSpaceErrorHeightFalloff: 0.25,
          })
        );
        viewer.scene.primitives.add(tileset);
        tileset.readyPromise.then(function (tileset) {
          update3dtilesMaxtrix(tileset);
        });
      }
      //倾斜摄影位置更新
      function update3dtilesMaxtrix(tileset) {
        //旋转
        var mx = Cesium.Matrix3.fromRotationX(Cesium.Math.toRadians(params.rx));
        var my = Cesium.Matrix3.fromRotationY(Cesium.Math.toRadians(params.ry));
        var mz = Cesium.Matrix3.fromRotationZ(Cesium.Math.toRadians(params.rz));
        var rotationX = Cesium.Matrix4.fromRotationTranslation(mx);
        var rotationY = Cesium.Matrix4.fromRotationTranslation(my);
        var rotationZ = Cesium.Matrix4.fromRotationTranslation(mz);
        //平移
        var position = Cesium.Cartesian3.fromDegrees(
          params.tx,
          params.ty,
          params.tz
        );
        var m = Cesium.Transforms.eastNorthUpToFixedFrame(position);
        //旋转、平移矩阵相乘
        Cesium.Matrix4.multiply(m, rotationX, m);
        Cesium.Matrix4.multiply(m, rotationY, m);
        Cesium.Matrix4.multiply(m, rotationZ, m);
        //比例缩放
        var scale = Cesium.Matrix4.fromUniformScale(params.scale);
        Cesium.Matrix4.multiply(m, scale, m);
        console.log("矩阵m:", m);
        //赋值给tileset
        tileset._root.transform = m;
      }
    </script>
  </head>
  <body onload="load()">
    <div
      id="map"
      style="
        z-index: 100;
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      "
    ></div>
  </body>
</html>
