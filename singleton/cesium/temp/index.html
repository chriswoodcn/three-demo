<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="Build/Cesium/Cesium.js"></script>
    <link rel="stylesheet" href="Build/Cesium/Widgets/widgets.css" />
    <script src="initMap.js"></script>
    <script>
      //在initMap.js进行初始化
      var viewer = null;
      function load() {
        //在线调用需要token
        Cesium.Ion.defaultAccessToken =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWRiZjk2YS0xMjVlLTQ4ZjctYjE0NS1kMTQ5ODU3M2EzYTkiLCJpZCI6NzkzMDQsImlhdCI6MTY0MTk3MzMyNH0.UaElO5H4GQ0z6rJKfl207sC5sqNJrEeRP3U-DOPZZrA";
        console.log("地图初始化");
        initMap(); //地图初始化
        //加载3D建筑物
        load3Dbuild();
      }
      function load3Dbuild() {
        console.log("js地图初始化完成,地图对象:", viewer);
        //3D建筑物
        //3D建筑物
        var tileset = new Cesium.Cesium3DTileset({
          url: Cesium.IonResource.fromAssetId(96188),
          modelMatrix: Cesium.Matrix4.fromArray([
            1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1,
          ]),
          maximumMemoryUsage: 100, //不可设置太高，目标机子空闲内存值以内，防止浏览器过于卡
          maximumScreenSpaceError: 50, //用于驱动细节细化级别的最大屏幕空间错误;较高的值可提供更好的性能，但视觉质量较低。
          shadows: false, //是否显示阴影
          skipLevelOfDetail: true,
          baseScreenSpaceError: 1024,
          skipScreenSpaceErrorFactor: 16,
          skipLevels: 1,
          immediatelyLoadDesiredLevelOfDetail: false,
          loadSiblings: false,
          cullWithChildrenBounds: true,
          dynamicScreenSpaceError: true,
          dynamicScreenSpaceErrorDensity: 0.00278,
          dynamicScreenSpaceErrorFactor: 4.0,
          dynamicScreenSpaceErrorHeightFalloff: 0.25,
        });
        var city = viewer.scene.primitives.add(tileset);
        city.shadows = false;
        console.log("city:", city);
        // 通过鼠标点击建筑物获取改建筑物的所有字段以及内容
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        handler.setInputAction(function (movement) {
          console.log("movement", movement);
          var feature = viewer.scene.pick(movement.position);
          console.log("feature：", feature);
          if (feature instanceof Cesium.Cesium3DTileFeature) {
            var propertyNames = feature.getPropertyNames();
            var length = propertyNames.length;
            for (var i = 0; i < length; ++i) {
              var propertyName = propertyNames[i];
              if (typeof feature.getProperty(propertyName) != "undefined") {
                console.log(
                  propertyName + ": " + feature.getProperty(propertyName)
                );
              }
            }
          }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        //定位
        var obj = {
          lng: 121.498,
          lat: 31.2418,
          eyeHeight: 2800,
          pitch: -25,
          heading: 87.0,
          time: 1,
        };
        viewerFlyToLonLat(obj);
      }
    </script>
  </head>
  <body onload="load()">
    <div
      id="map"
      style="
        z-index: 100;
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      "
    ></div>
  </body>
</html>
