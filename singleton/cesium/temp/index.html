<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="Build/CesiumUnminified/Cesium.js"></script>
    <link rel="stylesheet" href="Build/Cesium/Widgets/widgets.css" />
    <script src="initMap.js"></script>
    <script>
      //在initMap.js进行初始化
      var viewer = null;

      function load() {
        console.log("地图初始化");
        initMap();
      }

      //可编辑矩形

      function addRect() {
        var west = 118.0850887298584;
        var south = 24.439001083374023;
        var east = 118.1044813816513;
        var north = 24.451483144361173;
        entity = new Cesium.Entity({
          name: "rect",
          rectangle: {
            coordinates: Cesium.Rectangle.fromDegrees(west, south, east, north),
            outline: true,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 4,
            stRotation: Cesium.Math.toRadians(45),
            material: Cesium.Color.GREENYELLOW.withAlpha(0.5),
          },
        });
        viewer.entities.add(entity);
      }

      //当前编辑点
      var currentPoint = null;
      //所有编辑点
      var pointsId = [];
      //事件
      var handler = null;
      //当前编辑事件
      var gon = null;
      //中心编辑点
      var centerPoint = null;

      function editRect() {
        document.getElementById("map").style.cursor = "pointer";
        //去掉双击事件
        viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(
          Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK
        );

        let isEditting = false;
        handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        //鼠标点击事件
        handler.setInputAction((event) => {
          let windowPosition = event.position;
          let pickedObject = viewer.scene.pick(windowPosition);
          if (Cesium.defined(pickedObject)) {
            let entity = pickedObject.id;
            if (entity.name === "rect" && !isEditting) {
              gon = entity;
              // 生成边界编辑点
              var degrees = gon.rectangle.coordinates.getValue();
              var cartesianArr = [];
              var westNorth = Cesium.Cartesian3.fromRadians(
                degrees.west,
                degrees.north
              );
              westNorth.flag = "westNorth";
              cartesianArr.push(westNorth);
              var eastNorth = Cesium.Cartesian3.fromRadians(
                degrees.east,
                degrees.north
              );
              eastNorth.flag = "eastNorth";
              cartesianArr.push(eastNorth);
              var eastSouth = Cesium.Cartesian3.fromRadians(
                degrees.east,
                degrees.south
              );
              eastSouth.flag = "eastSouth";
              cartesianArr.push(eastSouth);
              var westSouth = Cesium.Cartesian3.fromRadians(
                degrees.west,
                degrees.south
              );
              westSouth.flag = "westSouth";
              cartesianArr.push(westSouth);
              console.log("cartesianArr", cartesianArr);
              for (var i = 0; i < cartesianArr.length; i++) {
                var cartesian = cartesianArr[i];
                var point = viewer.entities.add({
                  name: "rect_point",
                  position: cartesian,
                  point: {
                    color: Cesium.Color.WHITE,
                    pixelSize: 8,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 1,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND, //贴地
                  },
                });
                point.flag = cartesian.flag;
                pointsId.push(point.id);
              }
              // 生成中心编辑点
              var centerLng = (degrees.west + degrees.east) / 2;
              var centerLat = (degrees.north + degrees.south) / 2;
              var rect_center_cartesian = Cesium.Cartesian3.fromRadians(
                centerLng,
                centerLat
              );
              var pointTemp = viewer.entities.add({
                name: "rect_point",
                position: rect_center_cartesian,
                point: {
                  color: Cesium.Color.RED,
                  pixelSize: 10,
                  outlineColor: Cesium.Color.BLACK,
                  outlineWidth: 1,
                  heightReference: Cesium.HeightReference.CLAMP_TO_GROUND, //贴地
                },
              });
              pointTemp.flag = "center";
              pointsId.push(pointTemp.id);

              isEditting = true;
              viewer.scene.screenSpaceCameraController.enableRotate = false;
              viewer.scene.screenSpaceCameraController.enableZoom = false;
            } else if (entity.name === "rect_point") {
              currentPoint = entity;
            }
          }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

        // 对鼠标移动事件的监听
        handler.setInputAction((event) => {
          if (isEditting && currentPoint && currentPoint.name == "rect_point") {
            //获取加载地形后对应的经纬度和高程：地标坐标
            var ray = viewer.camera.getPickRay(event.endPosition);
            var cartesian = viewer.scene.globe.pick(ray, viewer.scene);
            let points = [];
            if (!cartesian) {
              return;
            }
            //更新当前点的位置
            currentPoint.position = cartesian;
            for (var i = 0; i < pointsId.length; i++) {
              if (currentPoint.id == pointsId[i]) {
                var objTemp = currentPoint.position._value;
                objTemp.flag = currentPoint.flag;
                points.push(objTemp);
              } else {
                var id = pointsId[i];
                var objTemp = viewer.entities.getById(id).position._value;
                objTemp.flag = viewer.entities.getById(id).flag;
                points.push(objTemp);
              }
            }
            if (typeof currentPoint == "undefined") {
              var radians = Cesium.Rectangle.fromDegrees(
                west,
                south,
                east,
                north
              );
              return radians;
            }
            //当前移动是哪个点，获取新的矩形边界
            var ellipsoid = viewer.scene.globe.ellipsoid;
            var lngArr = [];
            var latArr = [];
            if (
              currentPoint.flag == "westNorth" ||
              currentPoint.flag == "eastSouth"
            ) {
              for (var i = 0; i < points.length; i++) {
                if (
                  points[i].flag == "westNorth" ||
                  points[i].flag == "eastSouth"
                ) {
                  var cartographic = ellipsoid.cartesianToCartographic(
                    points[i]
                  );
                  var lng = Cesium.Math.toDegrees(cartographic.longitude);
                  var lat = Cesium.Math.toDegrees(cartographic.latitude);
                  lngArr.push(lng);
                  latArr.push(lat);
                }
              }
            } else if (
              currentPoint.flag == "eastNorth" ||
              currentPoint.flag == "westSouth"
            ) {
              for (var i = 0; i < points.length; i++) {
                if (
                  points[i].flag == "eastNorth" ||
                  points[i].flag == "westSouth"
                ) {
                  var cartographic = ellipsoid.cartesianToCartographic(
                    points[i]
                  );
                  var lng = Cesium.Math.toDegrees(cartographic.longitude);
                  var lat = Cesium.Math.toDegrees(cartographic.latitude);
                  lngArr.push(lng);
                  latArr.push(lat);
                }
              }
            } else if (currentPoint.flag == "center") {
              var cartographic = ellipsoid.cartesianToCartographic(
                currentPoint.position._value
              );
              var centerLng = Cesium.Math.toDegrees(cartographic.longitude);
              var centerLat = Cesium.Math.toDegrees(cartographic.latitude);
              //console.log("centerLng",centerLng);
              var rectInfo = gon.rectangle.coordinates.getValue();
              //console.log("currentPoint.position",currentPoint.position._value);
              var rectWidth =
                Cesium.Math.toDegrees(rectInfo.east) -
                Cesium.Math.toDegrees(rectInfo.west);
              var rectHeight =
                Cesium.Math.toDegrees(rectInfo.north) -
                Cesium.Math.toDegrees(rectInfo.south);
              //console.log("rectWidth:",rectWidth);
              var rectInfoEast = centerLng + rectWidth / 2;
              lngArr.push(rectInfoEast);
              var rectInfoWest = centerLng - rectWidth / 2;
              lngArr.push(rectInfoWest);
              var rectInfoNorth = centerLat + rectHeight / 2;
              latArr.push(rectInfoNorth);
              var rectInfoSouth = centerLat - rectHeight / 2;
              latArr.push(rectInfoSouth);
              //console.log("rectInfoEast",rectInfoEast);
              //console.log("经度组：",lngArr);
            }
            var east = Math.max.apply(null, lngArr);
            var west = Math.min.apply(null, lngArr);
            var north = Math.max.apply(null, latArr);
            var south = Math.min.apply(null, latArr);
            //更新所有编辑点的位置
            for (var i = 0; i < pointsId.length; i++) {
              var id = pointsId[i];
              var entityTemp = viewer.entities.getById(id);
              if (
                typeof entityTemp != "undefined" &&
                typeof currentPoint != "undefined"
              ) {
                if (entityTemp.flag != currentPoint.flag) {
                  if (entityTemp.flag == "westNorth") {
                    entityTemp.position = Cesium.Cartesian3.fromDegrees(
                      west,
                      north
                    );
                  } else if (entityTemp.flag == "eastNorth") {
                    entityTemp.position = Cesium.Cartesian3.fromDegrees(
                      east,
                      north
                    );
                  } else if (entityTemp.flag == "eastSouth") {
                    entityTemp.position = Cesium.Cartesian3.fromDegrees(
                      east,
                      south
                    );
                  } else if (entityTemp.flag == "westSouth") {
                    entityTemp.position = Cesium.Cartesian3.fromDegrees(
                      west,
                      south
                    );
                  } else if (entityTemp.flag == "center") {
                    var centerLng = (west + east) / 2;
                    var centerLat = (north + south) / 2;
                    entityTemp.position = Cesium.Cartesian3.fromDegrees(
                      centerLng,
                      centerLat
                    );
                  }
                }
              }
            }
            //console.log("坐标：",west, south, east, north);
            if (west >= east || south >= north) {
              currentPoint = undefined;
              return;
            }
            var radians = Cesium.Rectangle.fromDegrees(
              west,
              south,
              east,
              north
            );
            //更新矩形位置
            gon.rectangle.coordinates = new Cesium.CallbackProperty(function (
              time,
              result
            ) {
              return radians;
            },
            false);
          }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        // 对鼠标抬起事件的监听
        handler.setInputAction((event) => {
          // isEditting = false;
          currentPoint = undefined;
        }, Cesium.ScreenSpaceEventType.LEFT_UP);
      }

      function endEditRect() {
        viewer.scene.screenSpaceCameraController.enableRotate = true;
        viewer.scene.screenSpaceCameraController.enableZoom = true;
        if (handler !== null && !handler.isDestroyed()) {
          handler.destroy();
        }
        for (let id of pointsId) {
          viewer.entities.removeById(id);
        }
        pointsId = [];

        var dke = gon.rectangle.coordinates.getValue();
        console.log("修改后的面坐标(笛卡尔)：", dke);

        var east = Cesium.Math.toDegrees(dke.east);
        var west = Cesium.Math.toDegrees(dke.west);
        var north = Cesium.Math.toDegrees(dke.north);
        var south = Cesium.Math.toDegrees(dke.south);
        console.log("矩形西南东北坐标:", west, south, east, north);

        gon = null;
        //鼠标变成默认
        document.getElementById("map").style.cursor = "default";
      }
    </script>
  </head>
  <body onload="load()">
    <input
      type="button"
      onclick="addRect();"
      value="添加可编辑矩形"
      style="
        position: absolute;
        left: 50px;
        top: 50px;
        background: blue;
        color: white;
        z-index: 9999;
        font-size: 24px;
      "
    />
    <input
      type="button"
      onclick="editRect();"
      value="鼠标选中可编辑矩形进入编辑"
      style="
        position: absolute;
        left: 50px;
        top: 100px;
        background: blue;
        color: white;
        z-index: 9999;
        font-size: 24px;
      "
    />
    <input
      type="button"
      onclick="endEditRect();"
      value="可编辑矩形结束编辑"
      style="
        position: absolute;
        left: 50px;
        top: 150px;
        background: blue;
        color: white;
        z-index: 9999;
        font-size: 24px;
      "
    />

    <div
      id="map"
      style="
        z-index: 100;
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      "
    ></div>
  </body>
</html>
